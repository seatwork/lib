class Que{constructor(e={}){const t=this._proxy(e);new Observer(e.data),document.addEventListener("DOMContentLoaded",(function(){new Compiler(document.body,t),t.ready&&t.ready(decodeURI(location.pathname),location.search.slice(1))})),document.addEventListener("deviceready",()=>{t.onDeviceReady&&t.onDeviceReady()},!1)}_proxy(e){return Object.keys(e).forEach(t=>{"function"==typeof e[t]&&(e.data[t]=e[t])}),e.data}}Que.get=function(e){return e.method="GET",this.request(e)},Que.post=function(e){return e.method="POST",this.request(e)},Que.put=function(e){return e.method="PUT",this.request(e)},Que.delete=function(e){return e.method="DELETE",this.request(e)},Que.request=function(e){const t={url:"./",data:null,method:"GET",async:!0,withCredentials:!1,contentType:"application/json",timeout:6e4,headers:{},onabort:function(){},ontimeout:function(){},success:function(){},fail:function(){}},i=new XMLHttpRequest;Object.assign(t,e),i.open(t.method,t.url,t.async),i.timeout=t.timeout,i.withCredentials=t.withCredentials,i.onerror=t.fail,i.setRequestHeader("Content-Type",t.contentType);for(let e in t.headers)t.headers.hasOwnProperty(e)&&i.setRequestHeader(e,t.headers[e]);i.onload=function(){let e=Que.parseJson(this.response);200===this.status?t.success(e):t.fail(e,this.status)},Que.isJson(t.data)&&(t.data=JSON.stringify(t.data)),i.send(t.data)},Que.isJson=function(e){return"object"==typeof e&&"[object object]"==Object.prototype.toString.call(e).toLowerCase()&&!e.length},Que.parseJson=function(e){try{return JSON.parse(e)}catch(t){return e}},Que.customEvents={},Que.directive=function(e,t){Que.customEvents[e]=t};class Observer{constructor(e){this.observe(e)}observe(e){e&&"object"==typeof e&&Object.keys(e).forEach(t=>{this.observeObject(e,t,e[t])})}observeObject(e,t,i){let s=new Dep;this.observeRecursive(i,s),Object.defineProperty(e,t,{enumerable:!0,configurable:!1,get:()=>(Dep.target&&s.addSub(Dep.target),i),set:e=>{i!==e&&(i=e,this.observeRecursive(i,s),s.notify())}})}observeRecursive(e,t){Array.isArray(e)?(e.__proto__=this.definePrototype(t),e.forEach(e=>this.observe(e))):this.observe(e)}definePrototype(e){const t=Object.create(Array.prototype),i=this;return["push","pop","shift","unshift","splice","sort","reverse"].forEach(s=>{let r=t[s];Object.defineProperty(t,s,{enumerable:!0,writable:!0,configurable:!0,value:function(){const t=r.apply(this,arguments);let n=null;switch(s){case"push":case"unshift":n=arguments;break;case"splice":arguments.length>2&&(n=Array.prototype.slice.call(arguments,2))}return n&&i.observeRecursive(n,e),e.notify({method:s,args:arguments}),t}})}),t}}class Dep{constructor(){this.subs={}}addSub(e){this.subs[e.id]||(this.subs[e.id]=e)}removeSub(e){delete this.subs[e.id]}notify(e){Object.keys(this.subs).forEach(t=>{this.subs[t].update(e)})}}class Watcher{constructor(e,t,i){this.scope=e,this.expr=t,this.callback=i,this.id=++Watcher.id,this.compute=Parser.buildFunction(t),this.update()}update(e){let t=this.get();t=null==t?"":t,this.callback(t,e)}get(){Dep.target=this;let e=this.compute(this.scope);return Dep.target=null,e}}Watcher.id=0;class Directive{constructor(e,t,i){this.node=e,this.scope=t,Object.assign(this,i),this.init&&this.init(),this.expr&&this.update&&(this.watcher=new Watcher(this.scope,this.expr,(e,t)=>this.update(e,t)))}createAnchor(e){let t=document.createTextNode("");return(e=e||this.node).replace(t),t}}Directive.text={update(e){this.node.textContent=e}},Directive.attr={update(e){"data-src"==this.name?(this.node.removeAttribute("data-src"),this.node.setAttribute("src",e)):this.node.setAttribute(this.name,e)}},Directive.hidden={update(e){e?this.node.removeAttribute(this.name):this.node.setAttribute(this.name,!e)}},Directive.model={init(){this.node.removeAttribute(this.name),this.node.addEventListener("input",e=>{this.node.isInputing=!0,eval("this.scope."+this.expr+"=e.currentTarget.value")}),this.node.addEventListener("blur",e=>{this.node.isInputing=!1})},update(e){this.node.isInputing||(this.node.value=e)}},Directive.event={init(){const e=this.scope[this.fn];if(this.node.removeAttribute("@"+this.name),"function"==typeof e){const t=Que.customEvents[this.name];t?t(this.node,t=>{t.currentTarget=this.node,e.call(this.scope,t)}):this.node.addEventListener(this.name,t=>{e.call(this.scope,t)})}}},Directive.if={init(){let e=this.node.nextElementSibling;e&&e.hasAttribute("else")&&(e.removeAttribute("else"),this.elseNode=e,this.elseAnchor=this.createAnchor(e),this.compile(e,this.scope)),this.anchor=this.createAnchor(),this.compile(this.node,this.scope)},update(e){e?(this.anchor.replace(this.node),this.elseNode&&this.elseNode.replace(this.elseAnchor)):(this.node.replace(this.anchor),this.elseNode&&this.elseAnchor.replace(this.elseNode))}},Directive.foreach={init(){this.anchor=this.createAnchor(),this.itemNodes=[];const e=/\((.+),(.+)\)/,t=this.expr.match(/(.+) (?:in|of) (.+)/);if(t){this.expr=t[2],this.alias=t[1].trim();let i=t[1].match(e);i&&(this.alias=i[1].trim(),this.index=i[2].trim())}},update(e,t){let i=null;for(;i=this.itemNodes.pop();)i.remove();e&&e.forEach((e,t)=>{let i=Object.create(this.scope);i[this.alias]=e,this.index&&(i[this.index]=t);let s=this.node.cloneNode(!0);this.anchor.insert(s),this.itemNodes.push(s),this.compile(s,i)})}};class Compiler{constructor(e,t){const i=Compiler.createFragment(e);this.compile(i,t),e.appendChild(i)}createDirective(e,t,i){const s=Directive[i.type];s&&(Object.assign(i,s),i.compile=this.compile.bind(this),new Directive(e,t,i))}compile(e,t){1===e.nodeType&&"SCRIPT"!=e.tagName?this.compileElementNode(e,t):11===e.nodeType?this.compileElementNodes(e,t):3===e.nodeType&&this.compileTextNode(e,t)}compileElementNode(e,t){let i=Compiler.checkTerminalDirective(e);if(i)return e.removeAttribute(i.type),void this.createDirective(e,t,i);[].slice.call(e.attributes).forEach(s=>{i=Compiler.checkDirective(s),i&&this.createDirective(e,t,i)}),this.compileElementNodes(e,t)}compileElementNodes(e,t){const i=e.childNodes;i&&i.length&&i.forEach(e=>this.compile(e,t))}compileTextNode(e,t){const i=e.wholeText.trim();if(i){const s=Parser.parseMustache(i);s&&this.createDirective(e,t,{type:"text",expr:s})}}static createFragment(e){const t=document.createDocumentFragment();let i=null;for(;i=e.firstChild;)this.isIgnorableNode(i)?e.removeChild(i):t.appendChild(i);return t}static isIgnorableNode(e){return 8==e.nodeType||3==e.nodeType&&/^[\t\n\r]+/.test(e.textContent)}static checkTerminalDirective(e){let t=null;return["foreach","if"].some(i=>{if(e.hasAttribute(i))return t={type:i,expr:e.getAttribute(i)}}),t}static checkDirective(e){if(0===e.name.indexOf("@"))return{type:"event",name:e.name.substring(1),fn:e.value};const t=e.name.match(/(hidden|model)/);if(t)return{type:t[1],name:e.name,expr:e.value};const i=Parser.parseMustache(e.value);return i?{type:"attr",name:e.name,expr:i}:void 0}}class Parser{static parseMustache(e){const t=e.match(this.regMustache);if(t){const i=[];return e.split(this.regMustache).forEach(e=>{t.indexOf("{{"+e+"}}")>-1?i.push("("+e+")"):e&&i.push('"'+e+'"')}),i.join("+")}}static compute(e,t){return this.buildFunction(e)(t)}static buildFunction(e){let t=this.cache[e];if(!t){let i=this.isSimple(e)?"vm."+e:this.parseComplex(e);t=this.cache[e]=new Function("vm","return "+i)}return t}static isSimple(e){return this.regSimple.test(e)&&!this.regKeyword.test(e)}static parseComplex(e){const t=[];return e=(e=(" "+(e=(e=e.replace(this.regQuote,e=>{let i=t.length;return t[i]=e,'"'+i+'"'})).replace(/\s/g,""))).replace(this.regIdent,e=>{let t=e.charAt(0),i=e.slice(1);return this.regKeyword.test(i)?e:t+"vm."+i})).replace(/"(\d+)"/g,(e,i)=>t[i])}}Parser.cache={},Parser.regMustache=/\{\{(.+?)\}\}/g,Parser.regSimple=/^[A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\['.*?'\]|\[".*?"\]|\[\d+\]|\[[A-Za-z_$][\w$]*\])*$/,Parser.regKeyword=/^(?:true|false|null|undefined|Infinity|NaN|Math)$/,Parser.regQuote=/'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"/g,Parser.regIdent=/[^\w$\.](?:[A-Za-z_$][\w$]*)/g,[Element,Text,DocumentFragment].forEach(e=>{Object.assign(e.prototype,{insert(e){return this.parentNode&&this.parentNode.insertBefore(e,this)},replace(e){return this.parentNode&&this.parentNode.replaceChild(e,this)},remove(){return this.parentNode&&this.parentNode.removeChild(this)}})});
